server {
    listen 80;
    listen [::]:80;
    listen 127.0.0.1:443 ssl http2 proxy_protocol;
    server_name cc.cc www.cc.cc;

    real_ip_recursive on;
    real_ip_header proxy_protocol;
    include conf.d/common/ip.conf;
    include conf.d/common/server.conf;

    location / {
        rewrite ^/(.*)\.html$ /index?u=$1 break; #重写

        proxy_pass http://http_proxys_go_vpn;
        include conf.d/common/proxy.conf;
        proxy_set_header X-Forwarded-For $proxy_protocol_addr;
    }

}


server {
    listen 80;
    listen [::]:80;
    listen 127.0.0.1:443 ssl http2 proxy_protocol;
    server_name rancher.cc.cc;

    real_ip_recursive on;
    real_ip_header proxy_protocol;
    include conf.d/common/ip.conf;
    include conf.d/common/server.conf;

    location / {
        proxy_pass http://http_proxys_rancher;
        include conf.d/common/proxy.conf;
        proxy_set_header X-Forwarded-For $proxy_protocol_addr;
    }

}

server {
    listen 80 reuseport;
    listen [::]:80;
    listen 127.0.0.1:443 reuseport ssl http2 proxy_protocol;
    server_name go.cc.cc;
    index index.html index.htm default.html default.htm;
    error_log /var/www/logs/error_go_cc_cc.log;

    real_ip_recursive on;
    real_ip_header proxy_protocol;
    include conf.d/common/ip.conf;
    include conf.d/common/server.conf;

    location / {
        if ($host ~* ^www\.(?<nowww>.*)$) {
           rewrite .* $scheme://$nowww$request_uri permanent;
        }

        proxy_pass http://http_proxys_vite;
        include conf.d/common/proxy.conf;
        proxy_set_header X-Forwarded-For $proxy_protocol_addr;
    }

    location /api {
        rewrite ^/api/(.*)$ /$1 break; #重写
        if ($host ~* ^www\.(?<nowww>.*)$) {
           rewrite .* $scheme://$nowww$request_uri permanent;
        }

        proxy_pass http://http_proxys_go;
        include conf.d/common/proxy.conf;
        proxy_set_header X-Forwarded-For $proxy_protocol_addr;
    }

    location /api/swagger/index.html {
        if ($host ~* ^www\.(?<nowww>.*)$) {
           rewrite .* $scheme://$nowww$request_uri permanent;
        }

        proxy_pass http://http_proxys_go;
        include conf.d/common/proxy.conf;
        proxy_set_header X-Forwarded-For $proxy_protocol_addr;
     }

}
















server
{
    listen 80;
    listen [::]:80;
    listen 127.0.0.1:443 ssl http2 proxy_protocol;
    server_name admin.cc.cc;
    index index.html index.htm index.php default.html default.htm default.php;
    error_log  /var/www/logs/error_admin_cc_cc.log;
    # access_log /var/www/logs/access_admin_cc.cc.log httplog;

    real_ip_recursive on;
    real_ip_header proxy_protocol;
    include conf.d/common/ip.conf;
    include conf.d/common/server.conf;

    location / {
        if ($host ~* ^www\.(?<nowww>.*)$) {
           rewrite .* $scheme://$nowww$request_uri permanent;
        }

        proxy_pass http://http_proxys;
        include conf.d/common/proxy.conf;
        proxy_set_header X-Forwarded-For $proxy_protocol_addr;
    }




    location ~* \.(css|js|json|png|jpg|jpeg|gif|txt|ico|bmp|swf|mp3|mp4)$|^~/static/
    {
        proxy_pass http://http_proxys2;
        include conf.d/common/proxy.conf;

        proxy_redirect off;
        proxy_cache cache_one;
        proxy_cache_valid 200 302 24h;
        proxy_cache_valid 301 30d;
        proxy_cache_valid any 5m;
        access_log off;
        expires 30d;

        if ($uri ~ .*\.(js|css)?$) {
            expires 12h;
        }
    }

}


#作为代理(proxy)
server
{
    listen 8080;
    server_name admin.cc.cc;
    access_log off;

    real_ip_recursive on;
    real_ip_header X-Forwarded-For;
    include conf.d/common/ip.conf;

    location / {
        root /var/www/html/thinkPHP5.1-admin/public/;
        index index.html index.htm index.php default.html default.htm default.php;
        # if (!-e $request_filename) {
        #     rewrite ^/(.*)$ /index.php/$1 last;
        #     break;
        # }
        if (!-f $request_filename){
            set $rule_0 1$rule_0;
        }
        if (!-d $request_filename){
            set $rule_0 2$rule_0;
        }
        if ($rule_0 = "21"){
            rewrite ^/(.*)$ /index.php/$1 last;
        }
    }

    location ~ [^/]\.php(/|$) {
        root /var/www/html/thinkPHP5.1-admin/public/;
        include conf.d/common/php.conf;
    }

}


#用于静态文件
server
{
    listen 9090;
    server_name admin.cc.cc;

    location / {
        root /var/www/html/thinkPHP5.1-admin/public/;
    }
}
